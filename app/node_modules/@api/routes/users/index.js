const dataStore = require('@api/datastore')()

module.exports = (req, res, next) => {

  
  const validationErrorMessages = []

  /**
   * The list of fields that must be in the request body.
   * @type {Array}
   */
  const requiredFields = [
    'firstName',
    'lastName',
    'emailAddress',
    'password'
  ]

  /**
   * Verify that all of the required fields are present and have a non-blank
   * value.
   */
  requiredFields.forEach((field) => {
    if (
      /**
       * does the field exist?
       */
      !req.body[field] ||

      /**
       * is the value a string?
       */
      typeof req.body[field] !== 'string' ||

      /**
       * is it more than just white space?
       */
      req.body[field].trim().length === 0
    ) {
      validationErrorMessages.push(`missing required field ${field}`)
    }
  })

  if (validationErrorMessages.length > 0) {
    const err = new Error('')
    err.validationErrorMessages = validationErrorMessages
    throw err
  }

  dataStore.createUser({
    username: req.body.emailAddress,
    password: req.body.password,
    name: {
      first: req.body.firstName,
      last: req.body.lastName
    }
  })
    .then((userId) => {
      res.location(`/users/${userId}`).status(201)
      next()
    })
    .catch(err => {
      next(err)
    })

}
